<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .filters select, .filters input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .data-table th {
            background-color: #f5f5f5;
        }
        .data-table tbody tr:hover {
            background-color: #f9f9f9;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .badge-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .badge-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        .badge-primary {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom: 2px solid #4CAF50;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .loading::after {
            content: "Loading...";
            font-size: 18px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>File Upload Analytics Dashboard</h1>
            <a href="javascript:history.back()">Back to Dashboard</a>
        </div>
        
        <div class="filters">
            <select id="assignment-filter">
                <option value="">All Assignments</option>
                <option value="1">Assignment 1</option>
                <option value="2">Assignment 2</option>
                <option value="3">Assignment 3</option>
            </select>
            <input type="date" id="start-date" placeholder="Start Date">
            <input type="date" id="end-date" placeholder="End Date">
            <button id="filter-button">Apply Filters</button>
        </div>
        
        <div class="tab-container">
            <div class="tabs">
                <div class="tab active" data-tab="overview">Overview</div>
                <div class="tab" data-tab="submissions">Submissions</div>
                <div class="tab" data-tab="engagement">Student Engagement</div>
                <div class="tab" data-tab="grading">Grading Analysis</div>
            </div>
        </div>
        
        <!-- Overview Tab -->
        <div class="tab-content active" id="overview-tab">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Submissions</div>
                    <div class="stat-value" id="total-submissions">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Completion Rate</div>
                    <div class="stat-value" id="completion-rate">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Average Score</div>
                    <div class="stat-value" id="avg-score">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Views</div>
                    <div class="stat-value" id="total-views">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Downloads</div>
                    <div class="stat-value" id="total-downloads">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Student Participation</div>
                    <div class="stat-value" id="participation-rate">0%</div>
                </div>
            </div>
            
            <div class="dashboard">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Submissions Over Time</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="submissions-chart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Score Distribution</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="score-distribution-chart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">File Access Activity</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="file-access-chart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Submission Time Distribution</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="time-distribution-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Submissions Tab -->
        <div class="tab-content" id="submissions-tab">
            <div class="card full-width">
                <div class="card-header">
                    <h3 class="card-title">Submission Trends</h3>
                    <div>
                        <select id="trend-interval">
                            <option value="day">Daily</option>
                            <option value="week">Weekly</option>
                            <option value="month">Monthly</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="submission-trends-chart"></canvas>
                </div>
            </div>
            
            <div class="card full-width">
                <div class="card-header">
                    <h3 class="card-title">Top Accessed Submissions</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Challenge</th>
                            <th>Views</th>
                            <th>Downloads</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="top-submissions-table">
                        <tr>
                            <td colspan="5" class="loading"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Engagement Tab -->
        <div class="tab-content" id="engagement-tab">
            <div class="card full-width">
                <div class="card-header">
                    <h3 class="card-title">Student Engagement Metrics</h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Students With Submissions</div>
                        <div class="stat-value" id="students-with-submissions">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Students With Graded Work</div>
                        <div class="stat-value" id="students-with-grades">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Feedback View Ratio</div>
                        <div class="stat-value" id="feedback-view-ratio">0</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="engagement-chart"></canvas>
                </div>
            </div>
            
            <div class="card full-width">
                <div class="card-header">
                    <h3 class="card-title">Most Active Students</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Submissions</th>
                            <th>Views</th>
                            <th>Downloads</th>
                            <th>Total Activity</th>
                        </tr>
                    </thead>
                    <tbody id="active-students-table">
                        <tr>
                            <td colspan="5" class="loading"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Grading Tab -->
        <div class="tab-content" id="grading-tab">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Grading Insights</h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Avg Grading Time</div>
                        <div class="stat-value" id="avg-grading-time">0h</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">With Feedback</div>
                        <div class="stat-value" id="with-feedback">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Feedback Length</div>
                        <div class="stat-value" id="avg-feedback-length">0</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="grade-distribution-chart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Feedback Effectiveness</h3>
                </div>
                <div class="chart-container">
                    <canvas id="feedback-effectiveness-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let authToken = localStorage.getItem('authToken');
        let charts = {};
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });
        
        // Apply filters
        document.getElementById('filter-button').addEventListener('click', () => {
            loadDashboardData();
        });
        
        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            // Check for token in URL (from login)
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (token) {
                authToken = token;
                localStorage.setItem('authToken', token);
                
                // Remove token from URL
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
            
            // Initialize charts
            initCharts();
            
            // Load dashboard data
            loadDashboardData();
            
            // Trend interval change
            document.getElementById('trend-interval').addEventListener('change', () => {
                loadSubmissionTrends();
            });
        });
        
        function loadDashboardData() {
            const assignmentNumber = document.getElementById('assignment-filter').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            loadSubmissionStats(assignmentNumber);
            loadFileAccessStats(assignmentNumber, startDate, endDate);
            loadStudentEngagement(assignmentNumber);
            loadSubmissionTrends(assignmentNumber);
            loadGradingInsights(assignmentNumber);
        }
        
        function initCharts() {
            // Submissions Chart
            charts.submissions = new Chart(
                document.getElementById('submissions-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Submissions',
                            data: [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                }
            );
            
            // Score Distribution Chart
            charts.scoreDistribution = new Chart(
                document.getElementById('score-distribution-chart'),
                {
                    type: 'bar',
                    data: {
                        labels: ['0-59', '60-69', '70-79', '80-89', '90-100'],
                        datasets: [{
                            label: 'Number of Submissions',
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: [
                                '#ff6b6b',
                                '#feca57',
                                '#48dbfb',
                                '#1dd1a1',
                                '#5f27cd'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                }
            );
            
            // File Access Chart
            charts.fileAccess = new Chart(
                document.getElementById('file-access-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Views',
                                data: [],
                                borderColor: '#2196F3',
                                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'Downloads',
                                data: [],
                                borderColor: '#FF9800',
                                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                }
            );
            
            // Time Distribution Chart
            charts.timeDistribution = new Chart(
                document.getElementById('time-distribution-chart'),
                {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'Submissions',
                            data: Array(24).fill(0),
                            backgroundColor: '#9c88ff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                }
            );
            
            // Submission Trends Chart
            charts.submissionTrends = new Chart(
                document.getElementById('submission-trends-chart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Submissions',
                                data: [],
                                borderColor: '#4CAF50',
                                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                tension: 0.3,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Submission Rate (%)',
                                data: [],
                                borderColor: '#FFC107',
                                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                tension: 0.3,
                                fill: true,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Submission Count'
                                }
                            },
                            y1: {
                                beginAtZero: true,
                                position: 'right',
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Submission Rate (%)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                }
            );
            
            // Engagement Chart
            charts.engagement = new Chart(
                document.getElementById('engagement-chart'),
                {
                    type: 'pie',
                    data: {
                        labels: ['Submitted & Viewed Feedback', 'Submitted Only', 'Not Participated'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: [
                                '#4CAF50',
                                '#FFC107',
                                '#F44336'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                }
            );
            
            // Grade Distribution Chart
            charts.gradeDistribution = new Chart(
                document.getElementById('grade-distribution-chart'),
                {
                    type: 'bar',
                    data: {
                        labels: ['0-59', '60-69', '70-79', '80-89', '90-100'],
                        datasets: [{
                            label: 'Submissions',
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: [
                                '#ff6b6b',
                                '#feca57',
                                '#48dbfb',
                                '#1dd1a1',
                                '#5f27cd'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                }
            );
            
            // Feedback Effectiveness Chart
            charts.feedbackEffectiveness = new Chart(
                document.getElementById('feedback-effectiveness-chart'),
                {
                    type: 'bar',
                    data: {
                        labels: ['No Feedback', 'Short Feedback', 'Medium Feedback', 'Detailed Feedback'],
                        datasets: [{
                            label: 'Feedback View Rate',
                            data: [0, 0, 0, 0],
                            backgroundColor: '#3498db'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'View Rate (%)'
                                }
                            }
                        }
                    }
                }
            );
        }
        
        async function loadSubmissionStats(assignmentNumber = '') {
            try {
                const response = await fetch(`/api/v1/admin/analytics/file-uploads/stats?assignmentNumber=${assignmentNumber}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load submission statistics');
                
                const data = await response.json();
                const stats = data.data.stats;
                
                // Update stat values
                document.getElementById('total-submissions').textContent = stats.totalSubmissions;
                document.getElementById('completion-rate').textContent = `${stats.completionRate}%`;
                document.getElementById('avg-score').textContent = stats.scoreStats.avgScore ? 
                    stats.scoreStats.avgScore.toFixed(1) : '0';
                
                // Update score distribution chart
                if (charts.scoreDistribution) {
                    // This would need actual data mapped from the backend
                    // For now using dummy data based on score ranges
                    updateScoreDistributionChart(stats);
                }
                
                // Update time distribution chart
                if (charts.timeDistribution && stats.submissionTimeDistribution) {
                    updateTimeDistributionChart(stats.submissionTimeDistribution);
                }
                
            } catch (error) {
                console.error('Error loading submission stats:', error);
            }
        }
        
        async function loadFileAccessStats(assignmentNumber = '', startDate = '', endDate = '') {
            try {
                const params = new URLSearchParams();
                if (assignmentNumber) params.append('assignmentNumber', assignmentNumber);
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                
                const url = `/api/v1/admin/analytics/file-uploads/access?${params.toString()}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load file access statistics');
                
                const data = await response.json();
                const analytics = data.data.analytics;
                
                // Update stat values
                document.getElementById('total-views').textContent = analytics.accessByType.view || 0;
                document.getElementById('total-downloads').textContent = analytics.accessByType.download || 0;
                
                // Update file access chart
                if (charts.fileAccess && analytics.accessByDate) {
                    updateFileAccessChart(analytics.accessByDate);
                }
                
                // Update top submissions table
                if (analytics.topAccessedSubmissions && analytics.topAccessedSubmissions.length > 0) {
                    updateTopSubmissionsTable(analytics.topAccessedSubmissions);
                }
                
            } catch (error) {
                console.error('Error loading file access stats:', error);
            }
        }
        
        async function loadStudentEngagement(assignmentNumber = '') {
            try {
                const response = await fetch(`/api/v1/admin/analytics/file-uploads/engagement?assignmentNumber=${assignmentNumber}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load student engagement metrics');
                
                const data = await response.json();
                const metrics = data.data.metrics;
                
                // Update stat values
                document.getElementById('participation-rate').textContent = `${metrics.participationRate}%`;
                document.getElementById('students-with-submissions').textContent = metrics.studentsWithSubmissions;
                document.getElementById('students-with-grades').textContent = metrics.studentsWithGradedSubmissions;
                document.getElementById('feedback-view-ratio').textContent = metrics.feedbackViewRatio;
                
                // Update engagement chart
                if (charts.engagement) {
                    const viewedFeedback = Math.min(
                        metrics.studentsWithGradedSubmissions, 
                        Math.round(metrics.studentsWithSubmissions * metrics.feedbackViewRatio)
                    );
                    const submittedOnly = metrics.studentsWithSubmissions - viewedFeedback;
                    const notParticipated = metrics.totalStudents - metrics.studentsWithSubmissions;
                    
                    charts.engagement.data.datasets[0].data = [viewedFeedback, submittedOnly, notParticipated];
                    charts.engagement.update();
                }
                
            } catch (error) {
                console.error('Error loading student engagement:', error);
            }
        }
        
        async function loadSubmissionTrends(assignmentNumber = '') {
            try {
                const interval = document.getElementById('trend-interval').value;
                
                const response = await fetch(`/api/v1/admin/analytics/file-uploads/trends?assignmentNumber=${assignmentNumber}&interval=${interval}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load submission trends');
                
                const data = await response.json();
                const trends = data.data.trends;
                
                if (charts.submissionTrends && trends.submissionsByInterval.length > 0) {
                    const labels = trends.submissionsByInterval.map(item => item.interval);
                    const counts = trends.submissionsByInterval.map(item => item.count);
                    const rates = trends.submissionsByInterval.map(item => parseFloat(item.submissionRate));
                    
                    charts.submissionTrends.data.labels = labels;
                    charts.submissionTrends.data.datasets[0].data = counts;
                    charts.submissionTrends.data.datasets[1].data = rates;
                    charts.submissionTrends.update();
                    
                    // Also update the submissions chart on the overview tab
                    if (charts.submissions) {
                        charts.submissions.data.labels = labels;
                        charts.submissions.data.datasets[0].data = counts;
                        charts.submissions.update();
                    }
                }
                
            } catch (error) {
                console.error('Error loading submission trends:', error);
            }
        }
        
        async function loadGradingInsights(assignmentNumber = '') {
            try {
                const response = await fetch(`/api/v1/admin/analytics/file-uploads/grading?assignmentNumber=${assignmentNumber}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load grading insights');
                
                const data = await response.json();
                const insights = data.data.insights;
                
                // Update stat values
                document.getElementById('avg-grading-time').textContent = `${insights.avgGradingTimeHours}h`;
                document.getElementById('with-feedback').textContent = insights.feedbackMetrics.submissionsWithFeedback;
                document.getElementById('avg-feedback-length').textContent = insights.feedbackMetrics.averageFeedbackLength;
                
                // Update grade distribution chart
                if (charts.gradeDistribution && insights.scoreDistribution) {
                    charts.gradeDistribution.data.datasets[0].data = insights.scoreDistribution.map(item => item.count);
                    charts.gradeDistribution.update();
                    
                    // Also update score distribution chart on overview tab
                    if (charts.scoreDistribution) {
                        charts.scoreDistribution.data.datasets[0].data = insights.scoreDistribution.map(item => item.count);
                        charts.scoreDistribution.update();
                    }
                }
                
                // Update feedback effectiveness chart with dummy data for now
                if (charts.feedbackEffectiveness) {
                    // This would require additional backend analysis
                    // Using dummy data for now
                    const withoutFeedback = insights.feedbackMetrics.submissionsWithoutFeedback;
                    const withFeedback = insights.feedbackMetrics.submissionsWithFeedback;
                    const avgLength = insights.feedbackMetrics.averageFeedbackLength;
                    
                    // Categorize feedback by length
                    const short = Math.round(withFeedback * 0.3);
                    const medium = Math.round(withFeedback * 0.4);
                    const detailed = withFeedback - short - medium;
                    
                    // Dummy view rates
                    const noFeedbackRate = 20;
                    const shortFeedbackRate = 40;
                    const mediumFeedbackRate = 65;
                    const detailedFeedbackRate = 85;
                    
                    charts.feedbackEffectiveness.data.datasets[0].data = [
                        noFeedbackRate, shortFeedbackRate, mediumFeedbackRate, detailedFeedbackRate
                    ];
                    charts.feedbackEffectiveness.update();
                }
                
            } catch (error) {
                console.error('Error loading grading insights:', error);
            }
        }
        
        // Helper functions for chart updates
        function updateScoreDistributionChart(stats) {
            // For demo purposes - in production this would use real data from the API
            const scoreRanges = [
                { min: 0, max: 59 },
                { min: 60, max: 69 },
                { min: 70, max: 79 },
                { min: 80, max: 89 },
                { min: 90, max: 100 }
            ];
            
            // Generate random distribution that sums to total graded submissions
            // In production, this would come from the API
            const total = stats.gradedSubmissions;
            const data = [];
            let remaining = total;
            
            for (let i = 0; i < scoreRanges.length - 1; i++) {
                const count = i === scoreRanges.length - 1 ? 
                    remaining : Math.floor(Math.random() * remaining * 0.5);
                data.push(count);
                remaining -= count;
            }
            data.push(remaining);
            
            charts.scoreDistribution.data.datasets[0].data = data;
            charts.scoreDistribution.update();
        }
        
        function updateTimeDistributionChart(distribution) {
            const hours = Array.from({length: 24}, (_, i) => i);
            const data = hours.map(hour => distribution[hour] || 0);
            
            charts.timeDistribution.data.datasets[0].data = data;
            charts.timeDistribution.update();
        }
        
        function updateFileAccessChart(accessByDate) {
            // Convert object to arrays for chart
            const dates = Object.keys(accessByDate).sort();
            const counts = dates.map(date => accessByDate[date]);
            
            // For this demo, split counts randomly between views and downloads
            const viewCounts = [];
            const downloadCounts = [];
            
            counts.forEach(count => {
                const downloadCount = Math.floor(count * 0.3); // 30% are downloads
                const viewCount = count - downloadCount;
                viewCounts.push(viewCount);
                downloadCounts.push(downloadCount);
            });
            
            charts.fileAccess.data.labels = dates;
            charts.fileAccess.data.datasets[0].data = viewCounts;
            charts.fileAccess.data.datasets[1].data = downloadCounts;
            charts.fileAccess.update();
        }
        
        function updateTopSubmissionsTable(submissions) {
            const tableBody = document.getElementById('top-submissions-table');
            tableBody.innerHTML = '';
            
            submissions.forEach(sub => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${sub.studentName}</td>
                    <td>Challenge ${sub.challengeId}</td>
                    <td>${Math.round(sub.accessCount * 0.7)}</td>
                    <td>${Math.round(sub.accessCount * 0.3)}</td>
                    <td><span class="badge badge-${Math.random() > 0.3 ? 'success' : 'warning'}">
                        ${Math.random() > 0.3 ? 'Graded' : 'Pending'}
                    </span></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            if (submissions.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5">No data available</td>';
                tableBody.appendChild(row);
            }
        }
    </script>
</body>
</html>
